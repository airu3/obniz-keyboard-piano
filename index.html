<!DOCTYPE html>
<html lang="ja">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link
			rel="stylesheet"
			href="https://unpkg.com/modern-css-reset/dist/reset.min.css"
		/>
		<title>キーボード入力表示</title>
		<style>
			body {
				display: flex;
				flex-direction: column;
				justify-content: center;
				align-items: center;
				height: 100vh;
				margin: 0;
			}

			div {
				height: min-content;
				text-align: center;
			}
		</style>
		<script src="https://unpkg.com/obniz@3.x/obniz.js"></script>
	</head>
	<body>
		<h1>Active key</h1>
		<div id="activeKey"></div>
		<h2>Frequency (Hz)</h2>
		<div id="frequency"></div>
		<h2>Octave</h2>
		<div id="octave"></div>

		<script>
			const key2freq = new Map([
				["a", 207.652],
				["z", 220.0],
				["s", 233.082],
				["x", 246.942],
				["c", 261.626],
				["f", 277.183],
				["v", 293.665],
				["g", 311.127],
				["b", 329.628],
				["n", 349.228],
				["j", 369.994],
				["m", 391.995],
				["k", 415.305],
				[",", 440.0],
				["l", 466.164],
				[".", 493.883],
				["/", 523.251],
				[":", 554.365],
				["1", 415.305],
				["q", 440.0],
				["2", 466.164],
				["w", 493.883],
				["e", 523.251],
				["4", 554.365],
				["r", 587.33],
				["5", 622.254],
				["t", 659.255],
				["y", 698.456],
				["7", 739.989],
				["u", 783.991],
				["8", 830.609],
				["i", 880.0],
				["9", 932.328],
				["o", 987.767],
				["p", 1046.502],
				["-", 1108.731],
				["@", 1174.659],
				["^", 1244.508],
				["[", 1318.51],
				["\\", 1396.913],
			]);
			let octave = 0;

			const activeKeys = new Map();
			const elemActiveKey = document.getElementById("activeKey");
			const elemFrequency = document.getElementById("frequency");
			const elemOctave = document.getElementById("octave");

			const obniz = new Obniz("2600-9184");
			const speakers = [];

			obniz.onconnect = async () => {
				speakers.push(
					{
						assign: "",
						obniz: obniz.wired("Keyestudio_Buzzer", {
							signal: 0,
							vcc: 1,
							gnd: 2,
						}),
					},
					{
						assign: "",
						obniz: obniz.wired("Keyestudio_Buzzer", {
							signal: 9,
							vcc: 10,
							gnd: 11,
						}),
					}
				);
			};

			const calculateFrequency = (key) => {
				return key2freq.get(key) * Math.pow(2, octave);
			};

			const showActiveKeys = () => {
				const activeKeyList = Array.from(activeKeys.keys());
				elemActiveKey.textContent = activeKeyList.join("\n");
				elemFrequency.textContent = activeKeyList
					.map(calculateFrequency)
					.join("\n");
				elemOctave.textContent = octave;
			};

			const adjustOctave = (inputKey) => {
				const minOctave = -3;
				const maxOctave = 2;
				if (inputKey === "ArrowUp" && octave < maxOctave) {
					octave++;
				} else if (inputKey === "ArrowDown" && octave > minOctave) {
					octave--;
				}
			};

			const handleKeyDown = (event) => {
				if (event.repeat || !key2freq.has(event.key)) return;

				const speaker = speakers.find((spk) => spk.assign === "");
				const freq = calculateFrequency(event.key);
				activeKeys.set(event.key, speaker);

				if (speaker) {
					speaker.assign = event.key;
					speaker.obniz.play(freq);
				}

				showActiveKeys();
			};

			const handleKeyUp = (event) => {
				adjustOctave(event.key);
				const speaker = activeKeys.get(event.key);

				if (speaker) {
					speaker.assign = "";
					speaker.obniz.stop();
				}

				activeKeys.delete(event.key);
				showActiveKeys();
			};

			document.addEventListener("keydown", handleKeyDown);
			document.addEventListener("keyup", handleKeyUp);
		</script>
	</body>
</html>
